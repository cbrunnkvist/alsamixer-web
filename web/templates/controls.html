{{/*
  Mixer controls templates

  These templates are intended to be composed into a base layout
  using Go's html/template package. The "controls" template renders
  the main mixer area and iterates over sound cards; the "control"
  template renders a single mixer control with accessible ARIA
  attributes for volume sliders and switches.
*/}}

{{define "controls"}}
<main id="mixer-main" class="mixer-main" role="main" aria-label="ALSA mixer controls">
  <section id="mixer-live-region" class="sr-only" aria-live="polite" aria-atomic="true"></section>

  {{range .Cards}}
  <section class="mixer-card" aria-labelledby="card-{{.ID}}" data-card-id="{{.ID}}">
    <header class="mixer-card__header">
      <div class="mixer-card__title-row">
        <span class="mixer-card__index" aria-hidden="true">Card {{.ID}}</span>
        <h2 id="card-{{.ID}}" class="mixer-card__title">{{.Name}}</h2>
      </div>
      {{if .Description}}
      <p class="mixer-card__description">{{.Description}}</p>
      {{end}}
    </header>

    <div class="mixer-card__controls">
      {{range .Controls}}
        {{template "control" .}}
      {{end}}
    </div>
  </section>
  {{end}}
</main>
{{end}}

{{define "control"}}
<article class="mixer-control" data-control-id="{{.ID}}" data-card-id="{{.CardID}}" data-control-name="{{.Name}}">
  <header class="mixer-control__header">
    <div class="mixer-control__title-row">
      <h3 class="mixer-control__label">{{.Name}}</h3>
      <div class="mixer-control__type-badges" aria-hidden="true">
        {{if .HasVolume}}
        <span class="mixer-control__type-badge mixer-control__type-badge--volume">VOL</span>
        {{end}}
        {{if .HasMute}}
        <span class="mixer-control__type-badge mixer-control__type-badge--mute">MUTE</span>
        {{end}}
        {{if .HasCapture}}
        <span class="mixer-control__type-badge mixer-control__type-badge--capture">CAPTURE</span>
        {{end}}
      </div>
    </div>
    {{if .Description}}
    <p class="mixer-control__description" id="control-desc-{{.ID}}">{{.Description}}</p>
    {{end}}
  </header>

  <div class="mixer-control__body">
    {{/* Volume slider */}}
    {{if .HasVolume}}
    <div
      class="mixer-control__volume"
      role="slider"
      tabindex="0"
      aria-label="{{.VolumeAriaLabel}}"
      aria-valuemin="{{.VolumeMin}}"
      aria-valuemax="{{.VolumeMax}}"
      aria-valuenow="{{.VolumeNow}}"
      aria-valuetext="{{.VolumeText}}"
      aria-describedby="volume-help-{{.ID}}"
      data-control-kind="volume"
      hx-post="/control/volume"
      hx-trigger="click, keyup[key=='ArrowLeft' || key=='ArrowRight']"
      hx-swap="none"
      hx-vals='js:{ card: this.closest("[data-card-id]").dataset.cardId, control: this.closest("[data-control-name]").dataset.controlName, volume: this.getAttribute("aria-valuenow") }'
      style="--volume-percent: {{.VolumeNow}}%;">
      <div class="mixer-control__volume-track">
        <div class="mixer-control__volume-fill" aria-hidden="true"></div>
      </div>
      <span class="mixer-control__value" aria-hidden="true">{{.VolumeText}}</span>
    </div>
    <p id="volume-help-{{.ID}}" class="sr-only">
      Use left and right arrow keys to adjust the volume for {{.Name}}.
    </p>
    {{end}}

    {{/* Mute toggle */}}
    {{if .HasMute}}
    <button
      type="button"
      class="mixer-control__toggle mixer-control__toggle--mute"
      role="switch"
      aria-label="{{.MuteAriaLabel}}"
      aria-checked="{{if .Muted}}true{{else}}false{{end}}"
      aria-describedby="mute-help-{{.ID}}"
      data-control-kind="mute"
      hx-post="/control/mute"
      hx-trigger="click, keyup[key=='Enter' || key==' ' || key=='Space']"
      hx-swap="none"
      hx-vals='js:{ card: this.closest("[data-card-id]").dataset.cardId, control: this.closest("[data-control-name]").dataset.controlName, muted: this.getAttribute("aria-checked") === "true" }'
      hx-on='htmx:afterRequest: if (event.detail.successful) { const current = this.getAttribute("aria-checked") === "true"; const next = !current; this.setAttribute("aria-checked", next ? "true" : "false"); const label = this.querySelector(".mixer-control__toggle-label"); if (label) { label.textContent = next ? "Muted" : "Unmuted"; } const sr = document.getElementById("mute-help-{{.ID}}"); if (sr) { const name = this.closest("[data-control-name]").dataset.controlName || "{{.Name}}"; sr.textContent = next ? "Mute enabled for " + name + "." : "Mute disabled for " + name + "."; } }'>
      <span class="sr-only" id="mute-help-{{.ID}}">
        {{if .Muted}}Mute enabled for {{.Name}}.{{else}}Mute disabled for {{.Name}}.{{end}}
      </span>
      <span class="mixer-control__toggle-label" aria-hidden="true">
        {{if .Muted}}Muted{{else}}Unmuted{{end}}
      </span>
    </button>
    {{end}}

    {{/* Capture toggle */}}
    {{if .HasCapture}}
    <button
      type="button"
      class="mixer-control__toggle mixer-control__toggle--capture"
      role="switch"
      aria-label="{{.CaptureAriaLabel}}"
      aria-checked="{{if .CaptureActive}}true{{else}}false{{end}}"
      aria-describedby="capture-help-{{.ID}}"
      data-control-kind="capture"
      hx-post="/control/capture"
      hx-trigger="click, keyup[key=='Enter' || key==' ' || key=='Space']"
      hx-swap="none"
      hx-vals='js:{ card: this.closest("[data-card-id]").dataset.cardId, control: this.closest("[data-control-name]").dataset.controlName, active: this.getAttribute("aria-checked") === "true" }'
      hx-on='htmx:afterRequest: if (event.detail.successful) { const current = this.getAttribute("aria-checked") === "true"; const next = !current; this.setAttribute("aria-checked", next ? "true" : "false"); const label = this.querySelector(".mixer-control__toggle-label"); if (label) { label.textContent = next ? "Capture On" : "Capture Off"; } const sr = document.getElementById("capture-help-{{.ID}}"); if (sr) { const name = this.closest("[data-control-name]").dataset.controlName || "{{.Name}}"; sr.textContent = next ? "Capture enabled for " + name + "." : "Capture disabled for " + name + "."; } }'>
      <span class="sr-only" id="capture-help-{{.ID}}">
        {{if .CaptureActive}}Capture enabled for {{.Name}}.{{else}}Capture disabled for {{.Name}}.{{end}}
      </span>
      <span class="mixer-control__toggle-label" aria-hidden="true">
        {{if .CaptureActive}}Capture On{{else}}Capture Off{{end}}
      </span>
    </button>
    {{end}}
  </div>
</article>
{{end}}
